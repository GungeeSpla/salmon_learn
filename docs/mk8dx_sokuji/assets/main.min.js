"use strict";console.log("main.js is ver.0.3.0");var mouseChaser,inputRankData,scanedNameData,SCORES=[15,12,10,9,8,7,6,5,4,3,2,1],browser=(()=>{const e=window.navigator.userAgent.toLowerCase();return e.indexOf("msie")>-1||e.indexOf("trident")>-1?"ie":e.indexOf("edge")>-1?"edge":e.indexOf("chrome")>-1?"chrome":e.indexOf("safari")>-1?"safari":e.indexOf("firefox")>-1?"firefox":e.indexOf("opera")>-1?"opera":"other"})(),os=(()=>{const e=window.navigator.userAgent.toLowerCase();return e.indexOf("iphone")>-1?"iphone":e.indexOf("ipad")>-1?"ipad":e.indexOf("android")>-1?(e.indexOf("mobile"),"android"):e.indexOf("windows")>-1?"windows":e.indexOf("mac os x")>-1?"mac":"other"})(),isPC="windows"===os||"mac"===os,isTouchDevice="ontouchstart"in window,mousedownEvent=isTouchDevice?"click":"mousedown",queries=(()=>{var e=window.location.search.slice(1);return queries={},e?(e.split("&").forEach(function(e){var t=e.split("=");t[1]?queries[t[0]]=t[1]:queries[t[0]]=""}),queries):queries})(),isOverlay="1"===queries.overlay,playerNum=12,teamTableIndex=10,scKeyIndex=20,correctionIndex=30,rankTableIndex=40,correctionValues=[0,0,0,0,0,0],teamMaxNum=6,currentPen=-1,penDown=!1,rightDown=!1,isCalculating=!1,isInitialized=!1,sampleTeamData=null,storageKey="mk8dx-sokuji",saveTargetVariables=["teamNum","raceNum","teamNames","shortCutKeys","tallyConfig","inputRankData","correctionValues"],isEnabledSS=isPC,teamNum=2,raceNum=12,maxRaceNum=12,maxPlayerNum=12,teamNames=["AAA","BBB","CCC","DDD","EEE","FFF"],shortCutKeys=["a","b","c","d","e","f"],tallyConfig={onBeforeUnload:!1,isEnabledComplement:!0,latestScore:!0,latestScoreDif:!0,latestCource:!0,totalScore:!0,totalScoreDif:!0,leftRaceNum:!0,currentRank:!0,targetDistance:!0,winDetermine:!0,emphasisStr:"ã€ã€‘",emphasisStart:"",emphasisEnd:"",splitStr:"ï¼",teamSplitStr:"ï¼",passRank:2},overlayWindow=null;function initConfigElements(){[{key:"isEnabledComplement",id:"cfg-auto-complement"},{key:"latestScore",id:"cfg-latest-score"},{key:"latestScoreDif",id:"cfg-latest-score-dif"},{key:"totalScore",id:"cfg-total-score"},{key:"totalScoreDif",id:"cfg-total-score-dif"},{key:"latestCource",id:"cfg-latest-course"},{key:"leftRaceNum",id:"cfg-left-race-num"},{key:"currentRank",id:"cfg-current-rank"},{key:"targetDistance",id:"cfg-target-distance"},{key:"winDetermine",id:"cfg-win-determine"},{key:"onBeforeUnload",id:"cfg-on-before-unload"}].map(e=>{var t=document.getElementById(e.id);!0===tallyConfig[e.key]&&(t.setAttribute("checked","checked"),"onBeforeUnload"===e.key&&(window.onbeforeunload=function(){return overlayWindow&&overlayWindow.close(),"æœ¬å½“ã«ä»–ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã‹?"})),t.addEventListener("change",function(t){tallyConfig[e.key]=this.checked,setSaveStorage(),tallyForScores(),"cfg-on-before-unload"===this.id&&(this.checked?window.onbeforeunload=function(){return overlayWindow&&overlayWindow.close(),"æœ¬å½“ã«ä»–ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã‹?"}:window.onbeforeunload=function(){return overlayWindow&&overlayWindow.close(),null})},!1)}),[{key:"passRank",className:"cfg-pass-rank"},{key:"teamSplitStr",className:"cfg-team-split"},{key:"splitStr",className:"cfg-split"},{key:"emphasisStr",className:"cfg-emphasis"}].map(e=>{for(var t=document.querySelectorAll("[name="+e.className+"]"),a=0;a<t.length;a++){var r=t[a];""+tallyConfig[e.key]===r.getAttribute("value")&&r.setAttribute("checked","checked"),r.addEventListener("change",function(t){tallyConfig[e.key]=this.value,tallyConfig.passRank=parseInt(tallyConfig.passRank),tallyForScores(),setSaveStorage()})}}),updatePassRank(),document.getElementById("copy-button").addEventListener(mousedownEvent,function(e){execCopyResult()})}function initInputDataVariable(){inputRankData=[],scanedNameData=[];for(var e=0;e<maxRaceNum;e++){inputRankData[e]=[],scanedNameData[e]=[];for(var t=0;t<maxPlayerNum;t++)inputRankData[e][t]="-1",scanedNameData[e][t]=null}}function setEventShowMore(e){var t=document.querySelector(e),a=t.getAttribute("show"),r=document.querySelector("#"+a);t.addEventListener(mousedownEvent,function(e){"none"!==r.style.display?(r.style.display="none",this.textContent=this.getAttribute("text1")):(r.style.display="block",this.textContent=this.getAttribute("text2"))}),t.textContent=t.getAttribute("text1")}function makeRadioButtons(){return e(".race-num-radio","raceNum"),void e(".race-type-radio","teamNum");function e(e,a){for(var r=document.querySelectorAll(e),n=0;n<r.length;n++){t(r[n],a)}}function t(e,t){e.addEventListener("change",function(e){var a=parseInt(this.value);window[t]!==a&&(window[t]=a,updateInputTeamNameTable())}),window[t]===parseInt(e.value)&&e.setAttribute("checked","checked")}}function updateInputTeamNameTable(){return console.log("change race num / team num"),makeInputTeamNameTable(),makeInputRankPalette(),makeInputRankTable(),updatePassRank(),overlayWindow&&e(overlayWindow.document),void(isOverlay&&e(document));function e(e){e.querySelectorAll(".overlay-container").forEach(e=>{e.style.setProperty("display","none")}),e.querySelectorAll(`#team-num-${teamNum}`).forEach(e=>{e.style.setProperty("display","flex")})}}function updatePassRank(){for(var e=document.querySelectorAll(".cfg-pass-rank"),t=0;t<e.length;t++){var a=e[t];parseInt(a.getAttribute("rank"))>=teamNum?a.style.display="none":a.style.display="inline"}}function makeInputTeamNameTable(){logger.log("making team name / sc key / correction table");var e=document.querySelector("#table-team-name");e.innerHTML="";for(var t=teamNum,a=document.createElement("tr"),r=0;r<t;r++){var n=document.createElement("td");(l=createInput({placeholder:i=["A","B","C","D","E","F"][r],value:teamNames[r]})).setAttribute("tabIndex",teamTableIndex+r),l.setAttribute("id","input-team-name-"+r),l.addEventListener("input",makeInputRankPalette,!1),n.appendChild(l),a.appendChild(n)}e.appendChild(a);var o=document.querySelector("#table-sc-key");for(o.innerHTML="",a=document.createElement("tr"),r=0;r<t;r++){n=document.createElement("td");(l=createInput({placeholder:i=shortCutKeys[r],value:i,maxlength:"1"})).setAttribute("tabIndex",scKeyIndex+r),l.setAttribute("id","input-sc-key"+r),l.addEventListener("input",updateSCKey,!1),n.appendChild(l),a.appendChild(n)}o.appendChild(a);var s=document.querySelector("#table-correction");for(s.innerHTML="",a=document.createElement("tr"),r=0;r<t;r++){var i,l;n=document.createElement("td");(l=createInput({placeholder:0,value:i=correctionValues[r]})).setAttribute("tabIndex",correctionIndex+r),l.setAttribute("id","input-correction"+r),l.addEventListener("input",updateCorrection,!1),n.appendChild(l),a.appendChild(n)}s.appendChild(a)}function updateCorrection(){for(var e=!1,t=0;t<teamNum;t++){var a=document.getElementById("input-correction"+t),r=a.value;isNaN(parseInt(r)),r=r.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,e=>String.fromCharCode(e.charCodeAt(0)-65248)).replace("ãƒ¼","-").replace("ï¼","-");!isNaN(parseInt(r))?(correctionValues[t]!==parseInt(r)&&(e=!0),correctionValues[t]=parseInt(r),a.classList.remove("error")):(0!==correctionValues[t]&&(e=!0),correctionValues[t]=0,a.classList.add("error"))}e&&tallyForScores(),logger.log("update correction values "+JSON.stringify(correctionValues)),setSaveStorage()}function updateSCKey(){for(var e=0;e<teamNum;e++){var t=document.getElementById("input-sc-key"+e).value;shortCutKeys[e]=t}logger.log("update short cut keys "+JSON.stringify(shortCutKeys)),setSaveStorage()}function makeInputRankPalette(){return logger.log("making team palette"),function(){for(var e=0;e<teamNum;e++){var t=document.getElementById("input-team-name-"+e),a=t.value;teamNames[e]=a}logger.log("update team names "+JSON.stringify(teamNames))}(),function(){for(var e=1;e<=raceNum;e++)for(var t=1;t<=playerNum;t++){var a=document.body.querySelector(".rank-"+t+".race-"+e);if(a){var r=parseInt(a.getAttribute("team"));-1!==r&&(a.value=teamNames[r])}}}(),function(){var t=document.getElementById("input-rank-palette");t.innerHTML="";for(var a=-1;a<teamNum+1;a++){var r,n=document.createElement("div");r=a<0?"ã‚­ãƒ¼å…¥åŠ›":a===teamNum?"æ¶ˆã™":teamNames[a],n.innerHTML="<p>"+r+"</p>",n.setAttribute("id","palette-"+a),n.setAttribute("team-index",a),a===teamNum?n.classList.add("team-"+teamMaxNum):n.classList.add("team-"+a),e(n,a),t.appendChild(n)}isInitialized||t.querySelector("#palette--1").classList.add("selected")}(),function(){if(overlayWindow||isOverlay){var e=document.activeElement;if(e){var t=e.selectionEnd;tallyForScores(()=>{e.focus(),"input"===e.tagName.toLowerCase()&&"text"===e.getAttribute("type")&&e.setSelectionRange(t,t)})}else tallyForScores()}}(),void setSaveStorage();function e(e,t){e.addEventListener("contextmenu",function(e){e.preventDefault()},!1),e.addEventListener(mousedownEvent,function(e){selectPalette(t)},!1)}}function selectPalette(e){var t,a=document.getElementById("input-rank-palette").getElementsByTagName("div");for(t=0;t<a.length;t++)a[t].classList.remove("selected");var r=document.getElementById("palette-"+e);r.classList.add("selected");var n=parseInt(r.getAttribute("team-index"));if(currentPen=n,n>-1?document.getElementById("input-rank-table").classList.add("pen-mode"):document.getElementById("input-rank-table").classList.remove("pen-mode"),mouseChaser)if(n>-1){for(t=0;t<teamMaxNum+1;t++)mouseChaser.classList.remove("team-"+t);mouseChaser.classList.remove("hidden"),n===teamNum?(mouseChaser.textContent="ã€€",mouseChaser.classList.add("team-"+teamMaxNum)):(mouseChaser.textContent=teamNames[n],mouseChaser.classList.add("team-"+n))}else mouseChaser.classList.add("hidden")}function makeMouseChaser(){if(!isTouchDevice){var e=document.getElementById("input-rank-area");(mouseChaser=document.getElementById("mouse-chaser")).classList.add("mouse-chase"),mouseChaser.classList.add("hidden"),mouseChaser.textContent="NX",e.addEventListener("mousemove",function(e){var t=e.clientX,a=e.clientY,r="translate("+(t-=mouseChaser.clientWidth/2)+"px, "+(a-=mouseChaser.clientHeight/2+5)+"px)";return mouseChaser.style.transform=r,penDown&&currentPen>-1&&getSelection().removeAllRanges(),!0},!1),e.addEventListener("mouseenter",function(e){mouseChaser.style.display="block",penDown=!1,rightDown=!1}),e.addEventListener("mouseleave",function(e){mouseChaser.style.display="none",penDown=!1,rightDown=!1})}}function makeInputRankTable(){logger.log("making rank table");var e=document.getElementById("input-rank-table");e.innerHTML="";for(var t=raceNum+1,a=playerNum+2+(isEnabledSS?5:3),r=0;r<a;r++){var n=document.createElement("tr");r===playerNum+2&&n.classList.add("rank-end-tr");for(var o=0;o<t;o++)if(0===r&&o>1||0===o&&1===r);else{var s,i=document.createElement("td"),l="",c=1+o-1,u=1+r-2,m=(c-1)*(playerNum+1)+(u-1);o>=1&&r>=2&&r<playerNum+2?S(i,u,c,m):0===o&&0===r?(i.setAttribute("rowspan",2),l="é †ä½"):1===o&&0===r?(i.setAttribute("colspan",12),l="ãƒ¬ãƒ¼ã‚¹ç•ªå·"):1===r&&o>=1?l=o:0===o&&r>=2&&r<playerNum+2?l=r-1:0===o&&r===playerNum+2+1?l="ã€€":o>0&&r===playerNum+2+1?(l="",f(i,u,c,m)):0===o&&r===playerNum+2+2||(o>0&&r===playerNum+2+2?y(i,u,c,m):0===o&&r===playerNum+2+0?l="ã‚³ãƒ¼ã‚¹":o>0&&r===playerNum+2+0?k(i,u,c,m):0===o&&r===playerNum+2+3?l="ã‚¹ã‚¯ã‚·ãƒ§":o>0&&r===playerNum+2+3?v(i,u,c,m):0===o&&r===playerNum+2+4?(l="ã€€",i.classList.add("scanable-state")):o>0&&r===playerNum+2+4&&h(i,u,c,m)),l&&(i.textContent=l,i.classList.add("label")),r>=1&&(i.classList.add("race-"+c),i.setAttribute("race",c)),n.appendChild(i)}e.appendChild(n)}$("input.course-cell").MySuggest({msArrayList:MK8DX_COURSES});var d=document.querySelector(".rank-end-tr"),p=document.createElement("hr");n=document.createElement("tr");(i=document.createElement("td")).setAttribute("colspan",t),i.appendChild(p),n.appendChild(i),d.parentNode.insertBefore(n,d);for(var g=1;g<=raceNum;g++)updateRace(g,!1);return void tallyForScores();function y(e,t,a,r){b(e),e.classList.add("state-cell"),e.setAttribute("state-type","lack");var n=document.createElement("img");n.setAttribute("src-complete","assets/state-complete.png"),n.setAttribute("src-error","assets/state-error.png"),n.setAttribute("src-lack","assets/transparent.png"),n.setAttribute("src",n.getAttribute("src-lack")),e.appendChild(n)}function f(e,t,a,r){b(e);var n=document.createElement("img"),o="assets/lock-1.png";n.src=o,e.appendChild(n),e.classList.add("lock-cell"),e.addEventListener("click",function(e){for(var t=this.getAttribute("race"),a=document.querySelectorAll(".race-"+t),r=0;r<a.length;r++)a[r].classList.contains("locked")?(this.querySelector("img").src=o,a[r].classList.remove("locked")):(this.querySelector("img").src="assets/lock-2.png",a[r].classList.add("locked"))},!0)}function v(e,t,a,r){b(e),(s=document.createElement("div")).setAttribute("race",1+o-1),s.classList.add("paste-input"),s.classList.add("race-"+a),s.setAttribute("placeholder","paste"),setEventPasteImage(s,function(e,t){logger.log("ğŸï¸image pasted");var a=parseInt(t.getAttribute("race")),r=".pasted-image-cell.race-"+a+" img",n=document.querySelector(r);isCalculating?notifyFooter("è¨ˆç®—ä¸­ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚"):(isCalculating=!0,document.getElementById("mask-notice").style.setProperty("display","block"),setTimeout(()=>{trimGameScreen(e,e=>{scanGameScreen(e,t=>{isCalculating=!1,document.getElementById("mask-notice").style.setProperty("display","none"),scanedNameData[a-1]=t,n.style.setProperty("display","block"),n.src=e.toDataURL();var r=document.querySelector(`.pasted-image-cell.race-${a}`);r.classList.contains("specimen")&&(sampleTeamData=null,r.classList.remove("specimen")),existsSampleTeamData()&&scanTeamData(a)})},()=>{alert("ã‚²ãƒ¼ãƒ ç”»é¢ã®æŠ½å‡ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),isCalculating=!1,document.getElementById("mask-notice").style.setProperty("display","none")})},50))}),e.appendChild(s)}function h(e,t,a,r){b(e),e.classList.add("pasted-image-cell");var n=document.createElement("img");setEventZoomImage(n,a),e.appendChild(n)}function k(e,t,a,r){b(e),(s=createInput({className:"race-"+a+" course-cell",id:"rank-input-"+r,race:a,placeholder:"ã‚³ãƒ¼ã‚¹",tabIndex:rankTableIndex+r,"rank-input-id":r})).addEventListener("input",function(e){var t=this.selectionEnd;logger.log("inputed course [race "+a+"]["+this.value+"]","gray"),tallyForScores(()=>{this.focus(),this.setSelectionRange(t,t)})},!1),s.addEventListener("change",function(e){setTimeout(()=>{logger.log("inputed course [race "+a+"]["+this.value+"]","gray")},1),tallyForScores()},!1),e.appendChild(s)}function S(e,t,a,r){!function(e){e.addEventListener("mouseenter",()=>{mouseChaser&&(mouseChaser.style.display="block")})}(e),s=createRankInput(t,a,r),"-1"!==inputRankData[a-1][t-1]&&(s.value=teamNames[inputRankData[a-1][t-1]],resetRankInputClass(s,!1)),e.appendChild(s);var n=function(e){switch(e.type.toLowerCase()){case"mousedown":penDown=!0;break;case"mousemove":if(!penDown)return}if(!isTouchDevice&&(rightDown||2===e.button)){rightDown=!0;var t=this.querySelector("input"),a=parseInt(t.getAttribute("team"));return a<0&&(a=teamNum),selectPalette(a),!1}if(currentPen>-1){var r=(t=this.querySelector("input")).classList.contains("locked"),n=parseInt(this.getAttribute("race"));if(!r){var o;o=currentPen>=teamNum?"":teamNames[currentPen],t.value=o;var s=""===o;resetRankInputClass(t);var[i,l]=updateRace(n,!s);l&&tallyForScores()}return e.preventDefault(),!1}};e.oncontextmenu=function(e){return!1},e.addEventListener(mousedownEvent,n,!1),isTouchDevice||(e.addEventListener("mousemove",n,!1),e.addEventListener("mouseup",function(e){penDown=!1,rightDown=!1},!1),e.addEventListener("wheel",function(e){if(currentPen<0)return!0;e.preventDefault(),e.deltaY<0?currentPen>=1&&selectPalette(--currentPen):currentPen<teamNum&&selectPalette(++currentPen)}))}function b(e){e.addEventListener("mouseenter",()=>{mouseChaser&&(mouseChaser.style.display="none")})}}function createInput(e){var t=document.createElement("input");return t.setAttribute("type","text"),t.setAttribute("spellcheck","false"),t.setAttribute("user-scalable","no"),e&&Object.keys(e).map(a=>{"className"===a?e[a].split(" ").map(e=>{t.classList.add(e)}):t.setAttribute(a,e[a])}),t}function createRankInput(e,t,a){var r=document.createElement("input");return function(r){r.setAttribute("type","text"),r.setAttribute("spellcheck","false"),r.setAttribute("team","-1"),r.setAttribute("tabIndex",rankTableIndex+a),r.setAttribute("rank-input-id",a),r.setAttribute("id","rank-input-"+a),r.setAttribute("placeholder",e),r.setAttribute("race",t),r.setAttribute("rank",e),r.setAttribute("user-scalable","no"),r.classList.add("race-"+t),r.classList.add("rank-"+e)}(r),function(e){e.addEventListener(mousedownEvent,function(e){this.classList.contains("locked")&&this.blur()},!1),e.addEventListener("input",function(e){logger.log("inputed ["+e.data+"]","gray");var a=this.selectionEnd,r=null===e.data,n=function(e,t){var a=shortCutKeys.indexOf(t);if(a>-1&&a<teamNum)return e.value=teamNames[a],!0;return!1}(this,e.data);if(n)logger.log("parsed input ["+e.data+"] -> ["+this.value+"]","gray");else{var o=teamNames.indexOf(this.value);if(o<0){var s=this.value;(n=function(e){for(var t=e.value.toLowerCase(),a=0;a<teamNames.length;a++){var r=teamNames[a];if(t===r.toLowerCase())return e.value=r,!0}return!1}(this))&&logger.log("parsed name ["+s+"] -> ["+this.value+"]","gray")}}var i=resetRankInputClass(this),[l,c]=updateRace(t,!r);c?tallyForScores(()=>{this.blur()}):l?this.blur():i?focusDownRankInput(this):(this.focus(),this.setSelectionRange(a,a))}),e.addEventListener("keydown",function(e){switch(e.keyCode){case 13:focusNextRankInput(this);break;case 40:focusDownRankInput(this);break;case 38:focusUpRankInput(this)}},!1)}(r),r}function resetRankInputClass(e,t=!0){for(var a=0;a<teamNum+1;a++)e.classList.remove("team-"+a);e.setAttribute("team","-1");var r=parseInt(e.getAttribute("race")),n=parseInt(e.getAttribute("rank")),o=e.value,s=teamNames.indexOf(o),i=0<=s&&s<teamNum;i&&(e.classList.add("team-"+s),e.setAttribute("team",s),inputRankData[r-1][n-1]=s);var l=rankStrs[n-1];return t&&logger.log("inputed team [race "+r+"]["+l+"]["+e.value+"]","gray"),setSaveStorage(),i}function focusNextRankInput(e){var t=parseInt(e.getAttribute("rank-input-id")),a=document.getElementById("rank-input-"+(t+1));a&&a.focus()}function focusUpRankInput(e){var t,a=parseInt(e.getAttribute("rank-input-id"));a%(playerNum+1)>0&&(t=document.getElementById("rank-input-"+(a-1))),t&&t.focus()}function focusDownRankInput(e){var t,a=parseInt(e.getAttribute("rank-input-id"));a%(playerNum+1)<playerNum-1&&(t=document.getElementById("rank-input-"+(a+1))),t&&t.focus()}function updateRace(e,t){void 0===t&&(t=!0),t=t&&window.tallyConfig.isEnabledComplement;for(var a=document.body.querySelector(".state-cell.race-"+e),r=a.querySelector("img"),n=a.getAttribute("state-type"),o=0,s=[],i=createArray(teamNum,0),l=1;l<=playerNum;l++){var c=document.body.querySelector(".rank-"+l+".race-"+e),u=c.getAttribute("team");inputRankData[e-1][l-1]=u,"-1"===u?s.push(c):(o++,i[parseInt(u)]++)}var m,d=t;if(t){var p,g=playerNum/teamNum,y=-1;if(o>=g*(teamNum-1)&&o<playerNum){for(var f=0;f<teamNum;f++)if(i[f]===g);else if(i[f]<g){if(-1!==y){d=!1;break}p=teamNames[y=f]}}else d=!1;d&&(logger.log("complemented ranks"),s.map(e=>{e.value=p,resetRankInputClass(e),i[y]++}))}if(d)m="complete";else if(o===playerNum){for(m="complete",f=1;f<teamNum;f++)if(i[0]!==i[f]){m="error";break}}else m="lack";var v=n!==m;v&&logger.log("changed [race "+e+"] state ["+n+"] -> ["+m+"]");var h=document.querySelectorAll(".race-"+e),k=Math.min(h.length-4);for(f=0;f<k;f++)h[f].classList.remove("complete"),h[f].classList.remove("error"),h[f].classList.remove("lack"),h[f].classList.add(m);return a.setAttribute("state-type",m),r.setAttribute("src",r.getAttribute("src-"+m)),a.setAttribute("inputed","complete"===m?"inputed":""),[d,v]}function tallyForScores(e){logger.log("tallied scores","blue");var t,a,r=document.body.querySelectorAll(".state-cell"),n=0,o=[];for(t=0;t<r.length;t++)if("inputed"===r[t].getAttribute("inputed")){var s=r[t].getAttribute("race");a=s,o.push(s),n++}var i=raceNum-n,l="",c=document.body.querySelector(".course-cell.race-"+a);c&&(l=c.value);var u=[],m=[],d=[];for(t=0;t<teamNum;t++)u.push(0),m.push(0),d.push({teamIndex:t,teamName:teamNames[t],totalScore:0,latestScore:0,isCorrected:!1});o.map((e,t)=>{for(var a=1;a<=playerNum;a++){var r=parseInt(inputRankData[e-1][a-1]),n=SCORES[a-1];u[r]+=n,d[r].totalScore+=n,t===o.length-1&&(m[r]+=n,d[r].latestScore+=n)}}),d.map((e,t)=>{0!==correctionValues[t]&&(e.totalScore+=correctionValues[t],e.isCorrected=!0)}),d[0].latestScoreDif=d[0].latestScore-d[1].latestScore,d.sort((e,t)=>e.totalScore>t.totalScore?-1:e.totalScore<t.totalScore?1:e.teamIndex<t.teamIndex?-1:1),d.map((e,t)=>e.teamRank=t+1),d.map((e,t)=>{calcTargetDistance(d,t,tallyConfig.passRank)});var p=d[0],g=d[0].teamRank,y=d[0].totalScore;d[0].isTie=!1,d[0].teamRankTie=1,d.map((e,t)=>{t>0&&(y===e.totalScore?(p.isTie=!0,e.isTie=!0,e.teamRankTie=g):(e.isTie=!1,e.teamRankTie=e.teamRank,p=e,g=e.teamRank,y=e.totalScore))});var f=createTallyText(d,l,i);document.getElementById("result").textContent=f,isInitialized&&execCopy(f),e&&e()}function getScoreObject(e,t){for(var a=0;a<teamNum;a++)if(e[a].teamIndex===t)return e[a]}function calcTargetDistance(e,t,a){var r,n=getScoreObject(e,t),o=n.teamRank;r=o<=(a=Math.max(1,Math.min(teamNum-1,a)))?a+1:a,n.targetDistance=e[o-1].totalScore-e[r-1].totalScore,n.targetDistanceStr=r+"ä½ã¨ã®ç‚¹å·®:"+parseSignedNum(n.targetDistance)}function createTallyText(e,t,a){var r=tallyConfig,n=[],o=getScoreObject(e,0);if(r.emphasisStr.length>=2?(r.emphasisStart=r.emphasisStr.charAt(0),r.emphasisEnd=r.emphasisStr.charAt(1)):(r.emphasisStart="",r.emphasisEnd=""),2===teamNum){var s="";if(r.latestScore){for(c=0;c<teamNum;c++){c>0&&(s+="-"),s+=(u=getScoreObject(e,c)).latestScore}r.latestScoreDif&&(s+=" ("+parseSignedNum(o.latestScoreDif)+")")}else r.latestScoreDif&&(s+=parseSignedNum(o.latestScoreDif));s&&n.push(s)}var i="";if(2===teamNum){if(r.totalScore)for(i+="åˆè¨ˆ: ",c=0;c<teamNum;c++){var l=(m=(u=getScoreObject(e,c)).teamName)+" "+(d=u.totalScore);c>0&&(i+="-"),c>0&&(l=d+" "+m),i+=l}}else if(r.totalScore||r.totalScoreDif)for(var c=0;c<teamNum;c++){var u,m=(u=e[c]).teamName;0===u.teamIndex?(m=r.emphasisStart+m+r.emphasisEnd,c>0&&"ã€"!==r.emphasisStart&&" "===r.teamSplitStr.charAt(0)&&(m=" "+m),"ã€‘"!==r.emphasisEnd&&(m+=" ")):(c>0&&" "===r.teamSplitStr.charAt(0)&&(m=" "+m),m+=" ");var d=u.totalScore,p=o.totalScore-u.totalScore;p=p>0?"+"+p:0===p?"Â±0":""+p,r.totalScore?r.totalScoreDif&&o!==u&&(d=d+" ("+p+")"):r.totalScoreDif&&o!==u&&(d=p);l=m+d;c>0&&(i+=r.teamSplitStr),i+=l}if(i&&n.push(i),2===teamNum)r.totalScoreDif&&n.push("ç‚¹å·®: "+parseSignedNum(o.targetDistance));else{var g;if(r.currentRank)g=o.isTie?"ç¾åœ¨åŒ"+o.teamRankTie+"ä½":"ç¾åœ¨"+o.teamRank+"ä½",n.push(g);r.targetDistance&&n.push(o.targetDistanceStr)}var y="";r.latestCource&&(y+=t),r.leftRaceNum&&(y+="ï¼ "+a),y&&n.push(y);var f=0;switch(teamNum){case 2:f=40;break;case 3:f=36;break;case 4:f=31;break;case 6:f=24}var v=a*f,h=!1;1===o.teamRank&&(e[0].totalScore-e[1].totalScore>v&&r.winDetermine&&(h=!0,n.push("å‹åˆ©ç¢ºå®š!")));function k(t){t.querySelectorAll(`#team-num-${teamNum}`).forEach(t=>{2===teamNum?(t.querySelectorAll(".score").forEach((t,a)=>{t.innerText=getScoreObject(e,a).totalScore}),t.querySelectorAll(".team-span").forEach((t,a)=>{t.innerText=getScoreObject(e,a).teamName}),t.querySelectorAll(".score-dif").forEach((e,t)=>{e.classList.remove("plus"),e.classList.remove("minus"),e.classList.add(1===o.teamRank?"plus":"minus"),e.innerText=parseSignedNum(o.targetDistance)}),t.querySelectorAll(".win").forEach((e,t)=>{e.style.setProperty("display",h?"block":"none")}),t.querySelectorAll(".left-race").forEach((e,t)=>{e.innerText=`æ®‹ãƒ¬ãƒ¼ã‚¹:${a}`})):(t.querySelectorAll(".score").forEach((t,a)=>{t.innerText=e[a].totalScore}),t.querySelectorAll(".team-span").forEach((t,a)=>{t.innerText=e[a].teamName}),t.querySelectorAll(".dif").forEach((t,a)=>{t.innerText=parseSignedNum(e[a].totalScore-e[a+1].totalScore)}),t.querySelectorAll(".left-race").forEach((e,t)=>{e.innerText=`æ®‹${a}`})),t.querySelectorAll(".team-span").forEach(e=>{var t=e.parentNode,a=1;e.offsetWidth>t.offsetWidth&&(a=t.offsetWidth/e.offsetWidth),e.style.setProperty("transform",`scaleX(${a})`)})})}overlayWindow&&k(overlayWindow.document),isOverlay&&k(document);var S=!1;return e.forEach(e=>{e.isCorrected&&(S=!0)}),S&&n.push("è£œæ­£è¾¼ã¿")," /"===r.splitStr&&(r.splitStr=" / "),n.join(r.splitStr)}function parseSignedNum(e){return(e>0?"+":0===e?"Â±":"")+e}function execCopy(e){var t=document.createElement("div"),a=document.createElement("pre");a.style.webkitUserSelect="auto",a.style.userSelect="auto",t.appendChild(a).textContent=e;var r=t.style;r.position="fixed",r.right="200%",document.body.appendChild(t),document.getSelection().selectAllChildren(t);var n=document.execCommand("copy");return document.body.removeChild(t),n&&notifyFooter("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: "+e),n}function execCopyResult(){execCopy(document.getElementById("result").textContent)}function trigger(e,t){var a=document.createEvent("Event");a.initEvent(t,!0,!0),e.dispatchEvent(a)}window.onbeforeunload=function(){return overlayWindow&&overlayWindow.close(),null},window.addEventListener("load",function(){if(isOverlay&&document.body.classList.add("overlay-mode"),logger.log("document loaded"),logger.log("initializing mk8dx-sokuji"),initInputDataVariable(),loadStorage(),setEventShowMore("#input-rank-description-show"),setEventShowMore("#input-rank-description-show-2"),isEnabledSS||document.querySelector("#input-rank-description-show-2").style.setProperty("display","none"),makeRadioButtons(),updateInputTeamNameTable(),makeMouseChaser(),makeZoomImage(),initConfigElements(),isInitialized=!0,document.getElementById("reset-button").onclick=(()=>{window.confirm("é †ä½ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ç‚¹æ•°è£œæ­£ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")&&(sampleTeamData=null,initInputDataVariable(),correctionValues=[0,0,0,0,0,0],updateInputTeamNameTable(),setSaveStorage())}),document.getElementById("overlay-button").onclick=(()=>{overlayWindow&&overlayWindow.close(),setTimeout(()=>{overlayWindow=window.open("./overlay.html","overlay","width=840,height=160"),setTimeout(()=>{overlayWindow.document.querySelectorAll(".overlay-container").forEach(e=>{e.style.setProperty("display","none")}),overlayWindow.document.querySelectorAll(`#team-num-${teamNum}`).forEach(e=>{e.style.setProperty("display","flex")}),tallyForScores()},300)},300)}),isTouchDevice){var e=0;document.getElementById("input-rank-area").addEventListener("touchend",t=>{const a=window.performance.now();a-e<=500&&t.preventDefault(),e=a},!0),document.getElementById("input-rank-area").setAttribute("user-scalable","no")}logger.log("initialized mk8dx-sokuji")},!1),window.logger={log:(e,t)=>{if(t){e="%c"+e;var a="color: "+logger.color[t]+";";console.log(e,a)}else console.log(e)},color:{black:"#000",gray:"#aaa",blue:"#00f"}};var saveStorageTimer=null;function setSaveStorage(){clearTimeout(saveStorageTimer),saveStorageTimer=setTimeout(function(){saveStorage()},1e3)}function saveStorage(){var e={};saveTargetVariables.map(t=>{e[t]=window[t]});var t=JSON.stringify(e);localStorage.setItem(storageKey,t),logger.log("set storage data")}function loadStorage(){var e=localStorage.getItem(storageKey);if(null!==e){logger.log("storage data exist"),logger.log("merging variables to window");var t=JSON.parse(e);saveTargetVariables.map(e=>{void 0!==t[e]&&("tallyConfig"===e?Object.keys(t[e]).forEach(a=>{window[e][a]=t[e][a]}):window[e]=t[e])})}else logger.log("storage data doesn't exist")}function scanTeamData(e){if(!existsSampleTeamData())return alert("æ¨™æœ¬ã®ä½œæˆãŒæ¸ˆã‚“ã§ã„ã¾ã›ã‚“ã€‚"),!1;logger.log(`scaning race ${e}...`);var t=scanedNameData[e-1],a=getTeamRankArray(t,sampleTeamData);logger.log("scaned!"),logger.log(a);for(var r=1;r<=12;r++){var n=".race-"+e+".rank-"+r,o=document.querySelector(n);o.value=a[r-1],resetRankInputClass(o)}return updateRace(e),tallyForScores(),!0}function makeSampleTeamData(e){if(logger.log(`making specimen with race ${e}...`),"inputed"===document.body.querySelector(`.state-cell.race-${e}`).getAttribute("inputed")){for(var t=scanedNameData[e-1],a=!0,r=0;r<t.length;r++)if(null===t[r]){a=!1;break}if(a){var n=inputRankData[e-1];sampleTeamData=[],t.forEach((e,t)=>{sampleTeamData.push({id:t,name:e,teamName:teamNames[n[t]]})}),logger.log("maked!"),logger.log(sampleTeamData);var o=document.querySelector(".specimen");return o&&o.classList.remove("specimen"),document.querySelector(`.pasted-image-cell.race-${e}`).classList.add("specimen"),!0}return logger.log(`error! race ${e} scan data is missing.`),alert("ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"),!1}return logger.log(`error! race ${e} rank is missing.`),alert("é †ä½ã®å…¥åŠ›ãŒæ¸ˆã‚“ã§ã„ã¾ã›ã‚“ã€‚"),!1}function existsSampleTeamData(){return null!==sampleTeamData}var rankStrs=["1st","2nd","3rd","4th","5th","6th","7th","8th","9th","10th","11th","12th"],hankakuStrs=["1","2","3","4","5","6","7","8","9","0","-","^","\\","q","w","e","r","t","y","u","i","o","p","[","a","s","d","f","g","h","j","k","l",";",":","]","z","x","c","v","b","n","m",",",".",",",".","/","\\","a","i","u","e","o"],zenkakuStrs=["ï¼‘","ï¼’","ï¼“","ï¼”","ï¼•","ï¼–","ï¼—","ï¼˜","ï¼™","ï¼","ï¼","ï¼¾","ï¿¥","ï½‘","ï½—","ï½…","ï½’","ï½”","ï½™","ï½•","ï½‰","ï½","ï½","ã€Œ","ï½","ï½“","ï½„","ï½†","ï½‡","ï½ˆ","ï½Š","ï½‹","ï½Œ","ï¼›","ï¼š","ã€","ï½š","ï½˜","ï½ƒ","ï½–","ï½‚","ï½","ï½","ï¼Œ","ï¼","ã€","ã€‚","ãƒ»","ï¿¥","ã‚","ã„","ã†","ãˆ","ãŠ"],MK8DX_COURSES=[["ãƒãƒªã‚«ã‚¹","marikasu"],["ã‚¦ã‚©ã‚¿ãƒ‘","whotapa","ulotapa","uxotapa"],["ãƒ‰ãƒƒã‚¹ãƒ³","dossun"],["éºè·¡","ã„ã›ã","iseki"],["æ–°ãƒãƒªã‚µ","ã—ã‚“ã¾ã‚Šã•","ã¾ã‚Šã•","marisa","sinmarisa","shinmarisa"],["ã­ã˜ã‚Œ","nejire","nejire"],["ãƒ˜ã‚¤é‰±","ã¸ã„ã“ã†","heikou"],["ãƒ˜ã‚¤ãƒ›ãƒ¼","heiho"],["ç©ºæ¸¯","ãã†ã“ã†","kuukou"],["ãƒ‰ãƒ«ã¿","dorumi"],["å²¬","ã¿ã•ã","misaki"],["ã‚¨ãƒ¬ãƒ‰ãƒ­","eredoro"],["ãƒ¯ãƒªã‚¹ãƒ","warisuno"],["é›ªå±±","ã‚†ãã‚„ã¾","yukiyama"],["ã‚¹ã‚«ã‚¬","sukaga"],["ãƒ›ãƒãƒ›ãƒ","honoehone"],["éª¨ã€…","ã»ã­ã»ã­","honehone"],["ã‚¯ãƒ‘ã‚­ãƒ£","kupakya"],["æ–°è™¹","ã—ã‚“ã«ã˜","shinniji","sinniji"],["ãƒ¨ã‚·ã‚µ","yoshisa","yosisa"],["ã‚¨ã‚­ãƒ","ekiba"],["ãƒ‰ãƒ©ãƒ­","doraro"],["ãƒŸãƒ¥ãƒ¼ãƒˆ","myu-to"],["ãƒ™ãƒ“ãƒ‘","bebipa"],["ãƒãƒ¼ã‚º","ti-zu","chi-zu"],["ãƒã‚¤ãƒãƒ£ãƒ¼","neitya-","neicha-"],["ã©ã†æ£®","doumori"],["ãƒ¢ãƒ¢ã‚«ãƒ³","momokan"],["ã‚¹ã‚¤ã‚­ãƒ£ãƒ‹","suikyani"],"GBA",["ãƒ—ã‚¯ãƒ“","pukubi"],["ãƒ—ã‚¯ãƒ—ã‚¯","pukupuku"],["ãƒã‚¤ã‚¦ã‚§ã‚¤","haiwei"],["ã‚«ãƒ©ã‚«ãƒ©","karakara"],["å¹³é‡","ã¸ã„ã‚„","heiya"],["ãƒ”ãƒã‚µ","pitisa","pichisa"],"DKJ",["ãƒãƒ¼ãƒãƒ¼","ha-ba-"],["ã‚¸ãƒ£ãƒ³ã‚°ãƒ«","janguru","zyanguru"],["ãƒ¯ãƒªã‚¹ã‚¿","warisuta"],["ã‚·ãƒ£ãƒ™","shabe","syabe"],["ã‚·ãƒ£ãƒ™ãƒ©ãƒ³","shaberan","syaberan"],["ãƒŸãƒ¥ãƒ¼ãƒ‘","myu-pa"],["ãƒ¨ã‚·ãƒ","yoshiba","yosiba"],["ãƒã‚¯ã‚¿ã‚¯","chikutaku","tikutaku"],["ãƒ‘ã‚¯ã‚¹ãƒ©","pakusura"],["ç«å±±","ã‹ã–ã‚“","kazan"],["ã‚°ãƒ©ã‚°ãƒ©","guragura"],"64è™¹",["ãƒ¯ãƒªé‰±","warikou"],"SFCè™¹",["ãƒ„ãƒ«ãƒ„ãƒ«","turuturu","tsurutsuru"],["ãƒã‚¤ãƒ©ãƒ«","hairaru"],["ãƒã‚ªãƒ‘","neopa"],["ãƒªãƒœãƒ³","ribon"],["ãƒ¡ãƒˆãƒ­","metoro"],["ãƒªãƒ³ãƒ¡ãƒˆ","rinmeto"],["ãƒªãƒ³ãƒªãƒ³","rinrin"],"BB",["ãƒ“ãƒƒã‚°ãƒ–ãƒ«ãƒ¼","bigguburu-"]];