"use strict";const canvas1=createCanvas(!1,1280,720),canvas2=createCanvas(!1,460,50),canvas3=createCanvas(!1,460,600),canvas4=createCanvas(!1,108,600),canvas5=createCanvas(!1,100,100),canvas6=createCanvas(!1,66,623);function scanGameScreen(e,t){const n=function(e,t,n,a,o,r,i){const c=function(e,t){d.data[e+0]=t,d.data[e+1]=t,d.data[e+2]=t},s=function(e,t,n){const a=4*(e+t*n),o=d.data[a+0],r=d.data[a+1],i=d.data[a+2];return o>180&&r>180&&i<100?1:0},l=t.width,u=t.height;t.ctx.drawImage(e,a,o,r,i,0,0,l,u);const d=t.ctx.getImageData(0,0,l,u),m=function(e,t){let n,a,o=0;for(a=0,a=0;a<t;a++)o+=s(n,a,e);for(n=0,a=0;n<e;n++)o+=s(n,a,e);return o>100}(l,u);let h,p,v,g,f,w,y;for(p=0;p<u;p++)for(h=0;h<l;h++)v=4*(h+p*l),g=d.data[v+0],f=d.data[v+1],w=d.data[v+2],m?((y=550-g-f-w)<120&&(g=255),c(v,g)):c(v,g=(y=765-g-f-w)>500?255:255-(g+f+w)/3);return d};let a,o,r,i;console.log("- recognizing 1st - 12th player names"),canvas1.ctx.burnImage(e,0,0,canvas1.width,canvas1.height);const c=[];for(a=0;a<12;a++){canvas2.width=canvas3.width,r=(i=n(canvas1,canvas2,0,678,62+52*a,230,25)).width*i.height;const e=new Uint8Array(new ArrayBuffer(r));for(o=0;o<r;o++)e[o]=i.data[4*o];c.push(e),canvas3.ctx.putImageData(i,0,25*a*2)}for(a=0;a<12;a++)canvas2.width=canvas4.width,i=n(canvas1,canvas2,0,1164,65+52*a,54,25),canvas4.ctx.putImageData(i,0,25*a*2);const s=[];for(a=0;a<12;a++)s.push({top:50*a,left:0,width:460,height:50});"function"==typeof t&&t(c)}function getTeamRankArray(e,t){const n=[];e.forEach((e,a)=>{const o=[];t.forEach(t=>{const n=function(e,t){let n=0;for(let a=0;a<e.length;a++)n-=Math.abs(e[a]-t[a]);return n}(e,t.name);o.push({score:n,team:t.teamName})}),o.sort((e,t)=>e.score>t.score?-1:1),n.push({name:e,rank:a+1,topTeam:o[0].team,topScore:o[0].score,candidates:o})}),n.sort((e,t)=>e.topScore>t.topScore?-1:1);const a=[];t.forEach(e=>a.push(e.teamName)),n.forEach(e=>{for(let t=0;t<e.candidates.length;t++){const n=e.candidates[t],o=a.indexOf(n.team);if(o>=0){e.topTeam=n.team,e.topScore=n.score,a.splice(o,1);break}}}),n.sort((e,t)=>e.rank<t.rank?-1:1);const o=[];return n.forEach(e=>o.push(e.topTeam)),o}function checkScanable(e,t){"string"==typeof e&&(e=document.querySelector(e)),console.log("- checking necessity of trimming");const n=canvas5,a=e.naturalWidth,o=e.naturalHeight;n.width=a,n.height=o,n.ctx.globalAlpha="1",n.ctx.globalCompositeOperation="source-over",n.ctx.drawImage(e,0,0);const r=a/1280,i={},c={x:555,y:50,w:66,h:623};canvas6.width=c.w,canvas6.height=c.h,Object.keys(c).forEach(e=>{i[e]=c[e],c[e]=Math.round(c[e]*r)}),canvas6.ctx.fillStyle="#000",canvas6.ctx.clearRect(0,0,i.w,i.h),canvas6.ctx.burnImage(e,c.x,c.y,c.w,c.h,0,0,i.w,i.h);const s=Math.round(i.h/12);let l,u,d,m,h,p,v,g,f,w,y,x,$,b,I,E,S,T,k,L=!1;for(l=0;l<12;l++){const e=canvas6.ctx.getImageData(0,l*s,i.w,s);for(x=!1,k=i.w,L||(m=4*(4+25*k),(g=510-(h=e.data[m+0])-(p=e.data[m+1])+(v=e.data[m+2]))<(y=100)&&(x=!0,L=!0)),d=0;d<o;d++)for(u=0;u<k;u++)m=4*(u+d*k),f=(h=e.data[m+0])+(p=e.data[m+1])+(v=e.data[m+2]),h=p=v=x?f<y?255:0:(w=765-h-p-v)<y?255:f<y?0:255,e.data[m+0]=h,e.data[m+1]=p,e.data[m+2]=v;canvas6.ctx.putImageData(e,0,l*s)}for(l=0;l<12;l++)canvas6.ctx.fillRect(0,l*s-5,i.w,6);const P=document.querySelector("#rank-image-mono"),B=canvas6.ctx.getImageData(0,0,i.w,i.h);canvas6.ctx.drawImage(P,0,0);const C=canvas6.ctx.getImageData(0,0,i.w,i.h);for(g=0,k=i.w,d=0;d<o;d++)for(u=0;u<k;u++)m=4*(u+d*k),$=B.data[m+0],b=B.data[m+1],I=B.data[m+2],E=C.data[m+0],S=C.data[m+1],T=C.data[m+2],$===E&&b===S&&I===T||g++;const A=g<2e3;return A?console.log("- no need to trim"):console.log("- please trim"),A}function trimGameScreen(e,t,n){if("string"==typeof e){const t=new Image;t.src=e,e=t}checkScanable(e)?"function"==typeof t&&t(e,!1):trimGameScreenByRect(e,t,n)}const getWindowWidth=()=>window.innerWidth||!!document.body&&document.body.clientWidth||document.documentElement.clientWidth,getWindowHeight=()=>window.innerHeight||!!document.body&&document.body.clientHeight||document.documentElement.clientHeight;let $viewerWrapper,$viewerClose,$viewerInner,$viewerImage,$viewerRank,$viewerRankPs,$viewerButton,$viewerButtonRB,$viewerButtonMake,$viewerButtonRead,$viewerButtonClose,$viewerButtonPs,footerNotice,noticeTimer;function makeZoomImage(){$viewerWrapper=document.querySelector("#image-viewer-wrapper"),$viewerInner=document.querySelector("#image-viewer-inner"),$viewerImage=document.querySelector("#image-viewer-image"),$viewerRank=document.querySelector("#image-viewer-rank"),$viewerRankPs=document.querySelectorAll("#image-viewer-rank p"),$viewerButton=document.querySelector("#image-viewer-button"),$viewerButtonRB=document.querySelector("#image-viewer-button-rb"),$viewerButtonMake=document.querySelector("#image-viewer-button-make"),$viewerButtonRead=document.querySelector("#image-viewer-button-read"),$viewerButtonClose=document.querySelector("#image-viewer-button-close"),$viewerButtonPs=document.querySelectorAll("#image-viewer-button p"),footerNotice=document.querySelector("#footer-notice");const e=()=>{$viewerWrapper.style.setProperty("opacity","0"),setTimeout(()=>{$viewerWrapper.style.setProperty("display","none")},300)};$viewerButtonClose.addEventListener(mousedownEvent,e),$viewerButtonRead.addEventListener(mousedownEvent,()=>{let t=parseInt($viewerImage.getAttribute("race"));scanTeamData(t)&&e()}),$viewerButtonMake.addEventListener(mousedownEvent,()=>{let t=parseInt($viewerImage.getAttribute("race"));makeSampleTeamData(t)&&e()}),$viewerButtonRB.addEventListener(mousedownEvent,()=>{let t=document.querySelector(".fix-image-rb");t&&t.parentNode.removeChild(t);let n=new Image;n.src=$viewerImage.src,n.classList.add("fix-image-rb"),n.addEventListener(mousedownEvent,e=>(n.parentNode.removeChild(n),e.stopPropagation(),!1)),document.body.appendChild(n),e(),notifyFooter("クリックで消去できます。")})}function setEventZoomImage(e,t){"string"==typeof e&&(e=document.querySelector(e)),e.style.cursor="pointer",e.addEventListener(mousedownEvent,()=>{if(void 0!==t){$viewerImage.setAttribute("race",t);let e=inputRankData[t-1];document.querySelectorAll("#image-viewer-rank p").forEach((t,n)=>{t.innerText="",t.classList.add("team--1"),t.classList.remove("team-0"),t.classList.remove("team-1"),t.classList.remove("team-2"),t.classList.remove("team-3"),t.classList.remove("team-4"),t.classList.remove("team-5"),t.classList.remove("team-6"),"-1"!==e[n]&&(t.classList.remove("team--1"),t.classList.add(`team-${e[n]}`),t.innerText=teamNames[e[n]])})}const n=getWindowWidth(),a=getWindowHeight(),o=.8*n,r=.8*a,i=o/r,c=e.naturalWidth/e.naturalHeight;let s,l,u,d;i>c?s=(l=r)*c:l=(s=o)/c,u=(n-s)/2,d=(a-1.1*l)/2,$viewerInner.style.setProperty("width",`${s}px`),$viewerInner.style.setProperty("height",`${l}px`),$viewerInner.style.setProperty("top",`${d}px`),$viewerInner.style.setProperty("left",`${u}px`),$viewerButton.style.setProperty("top",`${l}px`),$viewerButton.style.setProperty("width",`${s}px`),$viewerButtonPs.forEach(e=>{e.style.setProperty("height",`${.11*l}px`),e.style.setProperty("line-height",`${.11*l}px`),e.style.setProperty("font-size",`${.05*l}px`)}),$viewerRankPs.forEach(e=>{e.style.setProperty("line-height",`${.05*l}px`),e.style.setProperty("font-size",`${.03*l}px`)}),$viewerImage.src=e.src,$viewerWrapper.style.setProperty("display","block"),setTimeout(()=>{$viewerWrapper.style.setProperty("opacity","1")},1)})}function notifyFooter(e){const t=document.createElement("p");t.textContent=e,t.style.setProperty("transition","none"),t.style.setProperty("display","block"),footerNotice.innerHTML="",footerNotice.appendChild(t),clearTimeout(noticeTimer),noticeTimer=setTimeout(()=>{clearTimeout(noticeTimer),noticeTimer=setTimeout(()=>{t.style.setProperty("transition",""),t.style.setProperty("opacity","0"),clearTimeout(noticeTimer),noticeTimer=setTimeout(()=>{footerNotice.innerHTML=""},600)},2e3)},1)}function setEventPasteImage(e,t){"string"==typeof e&&(e=document.querySelector(e));e.setAttribute("contenteditable","true"),e.innerHTML="<span>paste</span>",e.addEventListener("paste",function(e){const n=this;if(!e.clipboardData||!e.clipboardData.types||1!=e.clipboardData.types.length||"Files"!=e.clipboardData.types[0])return!0;const a=e.clipboardData.items[0].getAsFile(),o=new FileReader;return o.onload=function(e){const a=e.target.result,o=document.createElement("img");o.onload=function(e){o.onload=null,t&&t(this,n)},o.setAttribute("src",a)},o.readAsDataURL(a),this.innerHTML="<span>paste</span>",!1}),e.addEventListener("input",function(e){const n=this,a=document.createElement("div");a.innerHTML=this.innerHTML;const o=a.querySelector("img");o?t&&t(o,n):notifyFooter("画像データではありません。"),this.innerHTML="<span>paste</span>"})}function createTitledImage(e,t){const n=document.createElement("div");n.classList.add("titled-image-wrapper");const a=document.createElement("p");return a.textContent=t,n.appendChild(e),n.appendChild(a),n}function createCanvas(e,t,n){const a=document.createElement("canvas");return a.width=t,a.height=n,a.ctx=a.getContext("2d"),a.ctx.clear=function(){a.ctx.clearRect(0,0,a.width,a.height)},a.ctx.myDrawImage=function(e){a.ctx.drawImage(e,0,0,a.width,a.height)},a.ctx.burnImage=function(e){const t=arguments;function n(e,n){void 0!==e&&(a.ctx.globalCompositeOperation=e),void 0===n&&(n=1);for(let e=0;e<n;e++)a.ctx.drawImage.apply(a.ctx,t)}n("source-over",1),n("multiply",5),n("overlay",5),n("source-over",0)},a.fill=function(e){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.width,this.height)},a.init=function(e,t,n){this.width=e,this.height=t,this.ctx.globalAlpha="1",this.ctx.globalCompositeOperation="source-over",this.ctx.clear(),this.ctx.drawImage(n,0,0,e,t)},e&&document.body.appendChild(a),a}function createArray(e,t){const n=[];for(let a=0;a<e;a++)n[a]=t;return n}function createInt16Array(e){const t=new ArrayBuffer(e<<1),n=new Int16Array(t);for(let e=0;e<n.length;e++)n[e]=0;return n}function getRatio(e,t){const n=e>t,a=n?e:t,o=n?t:e;return 64*o<a?64:a/o}function trimGameScreenByRect(e,t,n){"string"==typeof e&&(e=document.querySelector(e)),console.log("- trimming the game screen");const a=canvas5,o=e.naturalWidth,r=e.naturalHeight;console.log(`- the image is (w, h) = (${o}, ${r})`),a.init(o,r,e);const i=Math.floor(15*o/100),c=Math.floor(15*r/100),s=function(e){let t,n,o,r,i,c,s,l,u,d,m,h;const p=function(){for(let e=0;e<2;e++)if(n>r[e]){for(let t=e;t+1<2;t++)r[t+1]=r[t],o[t+1]=o[t];r[e]=n,o[e]=t;break}n=0,t=l+1},v="vertical"===e,g=a.width,f=a.height;v?(i=g,c=f):(i=f,c=g);const w=a.ctx.getImageData(0,0,g,f),y=createInt16Array(2*i*2);for(s=0;s<i;s++){let e=-1,a=-1,i=-1;t=0,n=0,o=createArray(2,0),r=createArray(2,0);for(l=0;l<c;l++)u=v?4*(s+l*g):4*(l+s*g),d=w.data[u+0],m=w.data[u+1],h=w.data[u+2],d===e&&m===a&&h===i?n++:(n&&p(),e=d,a=m,i=h);p();for(let e=0;e<2;e++)y[0+2*(2*s+e)]=o[e],y[1+2*(2*s+e)]=r[e]}return y},l=function(e,t,n){const o="vertical"===e;let r,i;const c=a.width,s=a.height;o?(r=c,i=s):(r=s,i=c);const l=[-1],u=[-1],d=[];let m;const h=t.length/4;for(let e=0;e<h;e++){let a=0;for(let n=0;n<2;n++)a+=t[1+2*(2*e+n)];if(e>0&&Math.abs(a-m)>n){a<m?(l.push(e-1),u.push(e-1)):(l.push(e),d.push(e))}m=a}return l.push(r+1),d.push(r+1),[l,u,d]},u=s("horizontal"),d=s("vertical"),[m,h,p]=l("vertical",d,i),[v,g,f]=l("horizontal",u,c),w=function(e,t){const n=[],a=Math.floor(.05*o),i=Math.floor(.05*r);for(let o=0;o+1<e.length;o++){const r=e[o+0]+1,c=e[o+1]-r;if(c>a)for(let e=0;e+1<t.length;e++){const t=v[e+0]+1,a=v[e+1]-t;a>i&&n.push({x:r,y:t,w:c,h:a,s:c*a})}}return n.sort((e,t)=>e.s>t.s?-1:1),n}(m,v),y=(function(e){const t=Math.min(e.length,3),n=[];for(let a=0;a<e.length;a++){const o=e[a];let r=!0;for(let e=0;e<n.length;e++){const t=n[e],a=t.x===o.x&&t.w===o.w,i=t.y===o.y&&t.h===o.h;if(a||i){r=!1;break}}if(r&&n.push(o),n.length>=t)break}}(w),function(e,t,n,o,r){const i=function(e,t,n,a,o){for(let r=0;r<a.length;r++){const i=a[r]+1;for(let a=0;a<o.length;a++){const r=o[a]-i;let c;(c=e?{x:i,y:n.y,w:r,h:n.h,s:r*n.h}:{x:n.x,y:i,w:n.w,h:r,s:r*n.w}).w>l&&c.h>u&&c.w>c.h&&c.w<2*c.h&&t.push(c)}}},c=a.width,s=a.height,l=Math.floor(.05*c),u=Math.floor(.05*s),d=[];for(let a=0;a<e.length;a++){const c=e[a];d.push(c),i(!0,d,c,t,n),i(!1,d,c,o,r)}return function(e){e.forEach(e=>{const t=e.h/e.w;let n=Math.abs(9/16-t);t<9/16&&(n*=2),e.score=e.w/c-100*n})}(d),function(e){e.sort((e,t)=>e.score>t.score?-1:1)}(d),d}(w,h,p,g,f)[0]);y?(canvas6.width=1280,canvas6.height=720,canvas6.ctx.drawImage(e,y.x,y.y,y.w,y.h,0,0,1280,720),console.log("- trimed the game screen"),console.log(`- the game screen is (x, y, w, h) = (${y.x}, ${y.y}, ${y.w}, ${y.h})`),"function"==typeof t&&t(canvas6,!0)):(console.log("- sorry, trimming failed"),"function"==typeof n&&n())}